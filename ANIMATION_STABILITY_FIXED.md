# Исправления дрожания анимации при стоянии на платформах

## Проблема
Игрок дрожал между анимациями `idle` и `jump` при стоянии на платформах из-за микро-колебаний `velocity.y` и нестабильного состояния `is_grounded`.

## Решение

### 1. Буферная зона стабилизации

**Добавлен счетчик кадров в воздухе:**
```python
self.in_air_frames = 0  # Счетчик кадров в воздухе
```

**Стабилизация микро-скоростей:**
```python
# СТАБИЛИЗАЦИЯ СТОЯНИЯ (буфер для устранения дрожания)
if self.is_grounded and abs(self.velocity.y) < 0.5:
    self.velocity.y = 0  # Обнуляем микро-скорость
    self.in_air_frames = 0  # Счётчик кадров в воздухе
else:
    self.in_air_frames += 1
```

### 2. Эффективное состояние "на земле"

**Буферная зона против дрожания:**
```python
effective_on_ground = self.is_grounded and self.in_air_frames < 3
```

**Новая логика состояний:**
```python
if not effective_on_ground:
    self.current_state = "jumping"  # В воздухе
elif abs(self.velocity.x) > 0.1:
    self.current_state = "walking"  # Идёт по земле
else:
    self.current_state = "idle"     # Стоит стабильно
```

### 3. Улучшенная обработка коллизий

**Четкое позиционирование при приземлении:**
```python
# Приземление на платформу - ЧЕТКОЕ позиционирование
self.position.y = platform_rect.top - self.size.y
self.velocity.y = 0  # ПОЛНОЕ обнуление вертикальной скорости
self.is_grounded = True  # Устанавливается однозначно
```

### 4. Визуальная отладка

**Отладочная информация (F1):**
- `effective_on_ground` - эффективное состояние на земле
- `velocity.y` - должен быть 0.0 при стабильном стоянии
- `in_air_frames` - должен быть < 3 при стоянии
- Цветовая индикация проблем (желтый/оранжевый/красный)

## Результаты тестирования

✅ **Все тесты пройдены:**

1. **Стабильное стояние** - `idle` анимация
2. **Микро-дрожание (0.3px/s)** - стабилизируется в `idle`
3. **Реальное падение (50px/s)** - корректно `jumping`
4. **Буферная зона (2 кадра)** - остается `idle`
5. **Превышение буфера (4 кадра)** - переходит в `jumping`
6. **Медленное движение (0.05px/s)** - остается `idle`
7. **Нормальное движение (1.0px/s)** - корректно `walking`

## Параметры стабилизации

- **Буфер микро-скорости:** `< 0.5 px/s` обнуляется
- **Буфер кадров в воздухе:** `< 3 кадра` считается на земле
- **Порог движения:** `> 0.1 px/s` для анимации ходьбы

## Использование

1. **Запуск игры:** `python simple_game.py`
2. **Отладка:** Нажми `F1` для визуальной отладки
3. **Тестирование:** `python test_animation_stability.py`

## Файлы изменены

- `game/simple_player.py` - основные исправления
- `simple_game.py` - передача debug_mode
- `test_animation_stability.py` - тесты стабилизации

**Результат:** Полностью устранено дрожание анимации при стоянии на платформах!